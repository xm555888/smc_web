(function(w,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(w=typeof globalThis<"u"?globalThis:w||self,u(w.MoeAuthModal={}))})(this,function(w){"use strict";var u;(function(e){e.Call="call",e.Reply="reply",e.Syn="syn",e.SynAck="synAck",e.Ack="ack"})(u||(u={}));var C;(function(e){e.Fulfilled="fulfilled",e.Rejected="rejected"})(C||(C={}));var P;(function(e){e.ConnectionDestroyed="ConnectionDestroyed",e.ConnectionTimeout="ConnectionTimeout",e.NoIframeSrc="NoIframeSrc"})(P||(P={}));var A;(function(e){e.DataCloneError="DataCloneError"})(A||(A={}));var E;(function(e){e.Message="message"})(E||(E={}));const x=(e,o)=>{const t=[];let n=!1;return{destroy(r){n||(n=!0,o(`${e}: Destroying connection`),t.forEach(s=>{s(r)}))},onDestroy(r){n?r():t.push(r)}}},j=e=>(...o)=>{},H={"http:":"80","https:":"443"},U=/^(https?:)?\/\/([^/:]+)?(:(\d+))?/,K=["file:","data:"],V=e=>{if(e&&K.find(c=>e.startsWith(c)))return"null";const o=document.location,t=U.exec(e);let n,r,s;t?(n=t[1]?t[1]:o.protocol,r=t[2],s=t[4]):(n=o.protocol,r=o.hostname,s=o.port);const a=s&&s!==H[n]?`:${s}`:"";return`${n}//${r}${a}`},N=({name:e,message:o,stack:t})=>({name:e,message:o,stack:t}),Y=e=>{const o=new Error;return Object.keys(e).forEach(t=>o[t]=e[t]),o},q=(e,o,t)=>{const{localName:n,local:r,remote:s,originForSending:a,originForReceiving:c}=e;let f=!1;const l=i=>{if(i.source!==s||i.data.penpal!==u.Call)return;if(c!=="*"&&i.origin!==c){t(`${n} received message from origin ${i.origin} which did not match expected origin ${c}`);return}const g=i.data,{methodName:p,args:m,id:R}=g;t(`${n}: Received ${p}() call`);const M=h=>v=>{if(t(`${n}: Sending ${p}() reply`),f){t(`${n}: Unable to send ${p}() reply due to destroyed connection`);return}const y={penpal:u.Reply,id:R,resolution:h,returnValue:v};h===C.Rejected&&v instanceof Error&&(y.returnValue=N(v),y.returnValueIsError=!0);try{s.postMessage(y,a)}catch(d){if(d.name===A.DataCloneError){const S={penpal:u.Reply,id:R,resolution:C.Rejected,returnValue:N(d),returnValueIsError:!0};s.postMessage(S,a)}throw d}};new Promise(h=>h(o[p].apply(o,m))).then(M(C.Fulfilled),M(C.Rejected))};return r.addEventListener(E.Message,l),()=>{f=!0,r.removeEventListener(E.Message,l)}};let z=0;const W=()=>++z,D=".",b=e=>e?e.split(D):[],X=e=>e.join(D),B=(e,o)=>{const t=b(o||"");return t.push(e),X(t)},G=(e,o,t)=>{const n=b(o);return n.reduce((r,s,a)=>(typeof r[s]>"u"&&(r[s]={}),a===n.length-1&&(r[s]=t),r[s]),e),e},k=(e,o)=>{const t={};return Object.keys(e).forEach(n=>{const r=e[n],s=B(n,o);typeof r=="object"&&Object.assign(t,k(r,s)),typeof r=="function"&&(t[s]=r)}),t},J=e=>{const o={};for(const t in e)G(o,t,e[t]);return o},Q=(e,o,t,n,r)=>{const{localName:s,local:a,remote:c,originForSending:f,originForReceiving:l}=o;let i=!1;r(`${s}: Connecting call sender`);const g=m=>(...R)=>{r(`${s}: Sending ${m}() call`);let M;try{c.closed&&(M=!0)}catch{M=!0}if(M&&n(),i){const h=new Error(`Unable to send ${m}() call due to destroyed connection`);throw h.code=P.ConnectionDestroyed,h}return new Promise((h,v)=>{const y=W(),d=_=>{if(_.source!==c||_.data.penpal!==u.Reply||_.data.id!==y)return;if(l!=="*"&&_.origin!==l){r(`${s} received message from origin ${_.origin} which did not match expected origin ${l}`);return}const L=_.data;r(`${s}: Received ${m}() reply`),a.removeEventListener(E.Message,d);let T=L.returnValue;L.returnValueIsError&&(T=Y(T)),(L.resolution===C.Fulfilled?h:v)(T)};a.addEventListener(E.Message,d);const S={penpal:u.Call,id:y,methodName:m,args:R};c.postMessage(S,f)})},p=t.reduce((m,R)=>(m[R]=g(R),m),{});return Object.assign(e,J(p)),()=>{i=!0}},Z=(e,o,t,n,r)=>{const{destroy:s,onDestroy:a}=n;let c,f;const l={};return i=>{if(o!=="*"&&i.origin!==o){r(`Parent: Handshake - Received ACK message from origin ${i.origin} which did not match expected origin ${o}`);return}r("Parent: Handshake - Received ACK");const g={localName:"Parent",local:window,remote:i.source,originForSending:t,originForReceiving:o};c&&c(),c=q(g,e,r),a(c),f&&f.forEach(m=>{delete l[m]}),f=i.data.methodNames;const p=Q(l,g,f,s,r);return a(p),l}},ee=(e,o,t,n)=>r=>{if(!r.source)return;if(t!=="*"&&r.origin!==t){e(`Parent: Handshake - Received SYN message from origin ${r.origin} which did not match expected origin ${t}`);return}e("Parent: Handshake - Received SYN, responding with SYN-ACK");const s={penpal:u.SynAck,methodNames:Object.keys(o)};r.source.postMessage(s,n)},te=6e4,oe=(e,o)=>{const{destroy:t,onDestroy:n}=o,r=setInterval(()=>{e.isConnected||(clearInterval(r),t())},te);n(()=>{clearInterval(r)})},ne=(e,o)=>{let t;return e!==void 0&&(t=window.setTimeout(()=>{const n=new Error(`Connection timed out after ${e}ms`);n.code=P.ConnectionTimeout,o(n)},e)),()=>{clearTimeout(t)}},re=e=>{if(!e.src&&!e.srcdoc){const o=new Error("Iframe must have src or srcdoc property defined.");throw o.code=P.NoIframeSrc,o}},se=e=>{let{iframe:o,methods:t={},childOrigin:n,timeout:r,debug:s=!1}=e;const a=j(s),c=x("Parent",a),{onDestroy:f,destroy:l}=c;n||(re(o),n=V(o.src));const i=n==="null"?"*":n,g=k(t),p=ee(a,g,n,i),m=Z(g,n,i,c,a);return{promise:new Promise((M,h)=>{const v=ne(r,l),y=d=>{if(!(d.source!==o.contentWindow||!d.data)){if(d.data.penpal===u.Syn){p(d);return}if(d.data.penpal===u.Ack){const S=m(d);S&&(v(),M(S));return}}};window.addEventListener(E.Message,y),a("Parent: Awaiting handshake"),oe(o,c),f(d=>{window.removeEventListener(E.Message,y),d&&h(d)})}),destroy(){l()}}},ce={doneAndReturnTo(e=!1){const o=new URL(window.location.href);let t=o.searchParams.get("returnto");if(typeof t!="string")if(e)t="";else return this.reloadTopWindow();const n=new URLSearchParams(o.searchParams.get("returntoquery")||"");window.mw?location.href=mw.util.getUrl(t,Object.fromEntries(n.entries())):(o.pathname=`/${t}`.replace(/^\/+/,"/"),o.search=o.searchParams.get("returntoquery")||"",location.href=o.href)},reloadTopWindow(){location.reload()},cancelAndClose(){throw new Error("Not implemented")},error(e){}};function ae(e,o={},t=5e3){return se({iframe:e,methods:{...ce,...o},timeout:t})}const $={moe_auth_modal:"_moe_auth_modal_35ij6_1",open:"_open_35ij6_18",close:"_close_35ij6_22"},ie="https://app.moegirl.org.cn/moe-auth/";function de(e,o){const t=new URL(ie);return e=e.replace(/^#?\/+/,""),t.hash=`/${e}`,t.search=new URLSearchParams(o).toString(),t.toString()}function F(e,o="",t={},n={cancelAndClose(){this?.doneAndReturnTo?.(!0)}}){const r=document.createElement("iframe");r.src=de(o,t),r.allow="clipboard-write; clipboard-read",e.innerHTML="",e.appendChild(r);const s=ae(r,n),a=e.parentElement||document.body,c=new MutationObserver(f=>{for(const l of f){const i=Array.from(l.removedNodes);(i.includes(r)||i.includes(e))&&(s.destroy(),c.disconnect(),globalThis["".concat("console")].warn("MoeAuth iframe removed, RPC destroyed"))}});return c.observe(a,{childList:!0}),{iframe:r,rpc:s}}let I={x:window.innerWidth/2,y:window.innerHeight/2};document.addEventListener("mousemove",e=>{I={x:e.clientX,y:e.clientY}});const le=O;function O(e="",o={}){const t=document.querySelector(`.${$.moe_auth_modal}`);t&&t.classList.add($.close);const n=document.createElement("div");n.classList.add($.moe_auth_modal),n.style.transformOrigin=I.x+"px "+I.y+"px",document.body.appendChild(n);const{iframe:r,rpc:s}=F(n,e,o,{cancelAndClose:()=>{a()}});r.addEventListener("load",()=>{n.classList.add($.open)}),n.addEventListener("transitionend",c=>{c.propertyName==="opacity"&&+getComputedStyle(n).opacity<=0&&n.remove()});const a=()=>{n.classList.add($.close),s.destroy()};return a}w.create=O,w.renderIframe=F,w.show=le,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});

;(function () {
function injectCSS(payload) {
  const style = document.createElement("style");
  style.dataset.vitePackage = payload.packageName;
  style.dataset.viteFile = payload.fileName;
  style.innerHTML = payload.source;
  document.head.appendChild(style);
}
const cssEntries = [{"fileName":"index.css","name":"index.css","names":["index.css"],"needsCodeReference":false,"originalFileName":"style.css","originalFileNames":["style.css"],"source":"._moe_auth_modal_35ij6_1{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;box-shadow:0 0 0 999vmax #00000080;display:flex;justify-content:center;align-items:center;z-index:1000;overflow:hidden;transition:opacity .25s ease-in-out,transform .25s ease-in-out;opacity:.1;transform:scale(0)}._moe_auth_modal_35ij6_1._open_35ij6_18{opacity:1;transform:scale(1)}._moe_auth_modal_35ij6_1._close_35ij6_22{opacity:0;transform:scale(.25)}._moe_auth_modal_35ij6_1 iframe{width:100%;height:100%;border:none;overflow:hidden}\n","type":"asset","packageName":"MoeAuthModal"}];
cssEntries.forEach(injectCSS);
})()
